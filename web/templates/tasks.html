{% extends "base.html" %}

{% block title %}–ó–∞–¥–∞—á–∏ - Video Maker{% endblock %}

{% block extra_css %}
<style>
    :root {
        --primary-grad-start: #667eea;
        --primary-grad-end: #764ba2;
        --secondary-grad-start: #f093fb;
        --secondary-grad-end: #f5576c;
        --success-grad-start: #4facfe;
        --success-grad-end: #00f2fe;
        --error-grad-start: #fa709a;
        --error-grad-end: #fee140;
        --text-dark: #2d3748;
        --text-light: #718096;
        --bg-light: #f8f9fa;
        --border-color: #e2e8f0;
    }

    .tasks-dashboard {
        display: flex;
        gap: 24px;
        margin-top: 20px;
    }
    
    .task-list-container {
        flex: 1;
        max-width: 420px;
        background: linear-gradient(135deg, var(--primary-grad-start), var(--primary-grad-end));
        border-radius: 16px;
        padding: 20px;
        height: 85vh;
        overflow-y: auto;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
    }
    
    .task-list-container::-webkit-scrollbar { width: 8px; }
    .task-list-container::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.1); border-radius: 10px; }
    .task-list-container::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.3); border-radius: 10px; }
    
    .task-list-container h2 {
        color: white;
        margin: 0 0 20px 0;
        font-size: 24px;
        font-weight: 600;
    }
    
    .task-details-container {
        flex: 2;
        min-width: 0;
        height: 85vh;
        overflow-y: auto;
        padding-right: 10px;
    }
    .task-details-container::-webkit-scrollbar { width: 8px; }
    .task-details-container::-webkit-scrollbar-track { background: var(--bg-light); border-radius: 10px; }
    .task-details-container::-webkit-scrollbar-thumb { background: #d1d8e0; border-radius: 10px; }

    .task-item {
        padding: 18px;
        background: rgba(255, 255, 255, 0.95);
        border-radius: 12px;
        margin-bottom: 12px;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        border-left: 4px solid transparent;
    }
    
    .task-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        border-left-color: var(--primary-grad-start);
    }
    
    .task-item.active {
        background: white;
        border-left: 4px solid var(--secondary-grad-end);
        box-shadow: 0 8px 24px rgba(0,0,0,0.1);
        transform: translateY(-2px);
    }
    
    .task-item h4 {
        margin: 0 0 10px 0;
        color: var(--text-dark);
        font-size: 16px;
        font-weight: 600;
        word-break: break-word;
    }
    
    .task-status {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: white;
    }
    
    .task-status.running { background: linear-gradient(135deg, var(--secondary-grad-start), var(--secondary-grad-end)); animation: pulse 2s infinite; }
    .task-status.completed { background: linear-gradient(135deg, var(--success-grad-start), var(--success-grad-end)); }
    .task-status.failed { background: linear-gradient(135deg, var(--error-grad-start), var(--error-grad-end)); }
    .task-status.pending { background: linear-gradient(135deg, #ccc, #999); }
    
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.8; } }

    .detail-block, .sub-task-block {
        background: white;
        padding: 24px;
        border-radius: 16px;
        margin-bottom: 20px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        border: 1px solid var(--border-color);
        animation: fadeIn 0.4s ease-out;
    }

    .detail-block h3, .sub-task-block h4 {
        margin-top: 0;
        margin-bottom: 16px;
        color: var(--text-dark);
        font-size: 22px;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    .sub-task-block h4 { font-size: 18px; }

    .ai-clips-section {
        margin-top: 20px;
        padding-top: 20px;
        border-top: 2px solid #e0e0e0;
    }

    .ai-clips-section h5 {
        margin-bottom: 15px;
        color: var(--text-dark);
        font-size: 16px;
        font-weight: 600;
    }

    .ai-clips-cards {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 16px;
    }

    .ai-clip-card {
        background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
        border: 1px solid #e0e0e0;
        border-radius: 10px;
        padding: 16px;
        transition: all 0.2s ease;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .ai-clip-card:hover {
        border-color: var(--primary-color);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        transform: translateY(-1px);
    }

    .ai-clip-card-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 12px;
        padding-bottom: 10px;
        border-bottom: 1px solid #e8e8e8;
        gap: 10px;
    }

    .ai-clip-card-header h5 {
        margin: 0;
        font-size: 13px;
        color: var(--text-dark);
        flex: 1;
        word-break: break-word;
        line-height: 1.4;
        font-weight: 600;
    }

    .ai-clip-card-date {
        font-size: 10px;
        color: #888;
        white-space: nowrap;
        flex-shrink: 0;
    }

    .ai-clip-card-info {
        margin-bottom: 12px;
    }

    .ai-clip-card-info p {
        margin: 6px 0;
        font-size: 12px;
        color: var(--text-color);
        line-height: 1.4;
    }

    .ai-clip-card-info strong {
        color: var(--text-dark);
        font-weight: 600;
    }

    .ai-clip-card-actions {
        display: flex;
        gap: 6px;
        flex-wrap: wrap;
    }

    .btn-small {
        padding: 6px 10px;
        font-size: 12px;
        flex: 1;
        min-width: 80px;
        border-radius: 6px;
    }

    .ai-clip-card-subtasks {
        margin-top: 12px;
        padding-top: 12px;
        border-top: 1px solid #e8e8e8;
    }

    .btn-toggle-subtasks {
        width: 100%;
        padding: 8px;
        background: #f0f0f0;
        border: 1px solid #ddd;
        border-radius: 6px;
        cursor: pointer;
        font-size: 12px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        transition: background 0.2s;
    }

    .btn-toggle-subtasks:hover {
        background: #e8e8e8;
    }

    .toggle-icon {
        transition: transform 0.2s;
        font-size: 10px;
    }

    .subtasks-content {
        margin-top: 10px;
        padding: 10px;
        background: #fafafa;
        border-radius: 6px;
        animation: slideDown 0.3s ease-out;
    }

    @keyframes slideDown {
        from {
            opacity: 0;
            max-height: 0;
        }
        to {
            opacity: 1;
            max-height: 500px;
        }
    }
    
    .shorts-settings-form {
        margin-top: 12px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
        border: 1px solid #e0e0e0;
    }
    
    .shorts-form-content {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }
    
    .shorts-form-content h6 {
        color: var(--text-dark);
        font-size: 14px;
        font-weight: 600;
    }
    
    .shorts-form-content .form-group {
        margin-bottom: 0;
    }
    
    .shorts-form-content .form-group label {
        font-size: 12px;
        margin-bottom: 6px;
        color: #666;
    }
    
    .shorts-form-content .form-input,
    .shorts-form-content .form-select {
        font-size: 13px;
        padding: 8px 12px;
    }
    
    .shorts-form-actions {
        display: flex;
        gap: 8px;
        margin-top: 8px;
    }
    
    .shorts-form-actions .btn {
        flex: 1;
    }

    .subtask-item {
        margin-bottom: 12px;
        padding-bottom: 10px;
        border-bottom: 1px solid #e0e0e0;
    }

    .subtask-item:last-child {
        border-bottom: none;
        margin-bottom: 0;
    }

    .subtask-header {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 6px;
    }

    .subtask-icon {
        font-size: 14px;
    }

    .subtask-name {
        flex: 1;
        font-weight: 600;
        font-size: 13px;
        color: var(--text-dark);
    }

    .subtask-header .task-status {
        font-size: 10px;
        padding: 2px 6px;
    }

    .subtask-message {
        font-size: 11px;
        color: var(--text-color);
        margin: 4px 0;
    }

    .subtask-error {
        font-size: 11px;
        color: #d32f2f;
        margin: 4px 0;
    }

    .progress-bar-small {
        height: 4px;
        background: #e0e0e0;
        border-radius: 2px;
        overflow: hidden;
        margin: 6px 0;
    }

    .progress-bar-small .progress-bar-fill {
        height: 100%;
        background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
        transition: width 0.3s ease;
    }

    .subtask-outputs {
        margin-top: 6px;
        font-size: 11px;
    }

    .subtask-outputs a {
        color: var(--primary-color);
        text-decoration: none;
    }

    .subtask-outputs a:hover {
        text-decoration: underline;
    }

    .subtask-empty {
        font-size: 11px;
        color: #999;
        font-style: italic;
        text-align: center;
        padding: 10px;
    }

    .file-list {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 16px;
        margin-top: 12px;
    }
    
    .file-list a {
        display: flex;
        align-items: center;
        gap: 14px;
        padding: 16px 20px;
        background: var(--bg-light);
        border-radius: 12px;
        color: var(--text-dark);
        text-decoration: none;
        font-weight: 500;
        transition: all 0.3s ease;
        border: 1px solid var(--border-color);
    }

    .file-list a:hover {
        background: linear-gradient(135deg, var(--primary-grad-start), var(--primary-grad-end));
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 8px 24px rgba(102, 126, 234, 0.4);
    }

    .progress-bar { width: 100%; height: 8px; background: #e2e8f0; border-radius: 10px; overflow: hidden; margin-top: 8px; }
    .progress-bar-fill {
        width: 0%; height: 100%; background: linear-gradient(90deg, var(--primary-grad-start), var(--primary-grad-end)); transition: width 0.3s ease; border-radius: 10px;
    }

    .btn {
        padding: 12px 24px; border: none; border-radius: 10px; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.3s ease;
        background: linear-gradient(135deg, var(--primary-grad-start), var(--primary-grad-end)); color: white;
    }
    .btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.15); }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; }

    .status-message { padding: 14px 18px; border-radius: 10px; margin-top: 16px; font-weight: 500; border-left: 4px solid; }
    .status-message.success { background: #d4edda; color: #155724; border-left-color: #28a745; }
    .status-message.error { background: #f8d7da; color: #721c24; border-left-color: #dc3545; }
    .status-message.info { background: #d1ecf1; color: #0c5460; border-left-color: #17a2b8; }

    .form-group { margin-bottom: 20px; }
    .form-group label { display: block; margin-bottom: 8px; color: #4a5568; font-weight: 600; }
    .form-input, .form-select { width: 100%; padding: 12px 16px; border: 2px solid var(--border-color); border-radius: 10px; font-size: 15px; }
    .form-input:focus, .form-select:focus { outline: none; border-color: var(--primary-grad-start); }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
</style>
{% endblock %}

{% block content %}
<div class="tasks-dashboard">
    <div class="task-list-container" id="task-list">
        <!-- Workflows will be loaded here -->
    </div>
    <div class="task-details-container" id="task-details">
        <div class="detail-block">
            <h3>üëà –í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–±–æ—á–∏–π –ø—Ä–æ—Ü–µ—Å—Å</h3>
            <p>–ó–¥–µ—Å—å –±—É–¥–µ—Ç –ø–æ–∫–∞–∑–∞–Ω–∞ –ø–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º –ø—Ä–æ—Ü–µ—Å—Å–µ –∏ –µ–≥–æ –ø–æ–¥–∑–∞–¥–∞—á–∞—Ö.</p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const taskListContainer = document.getElementById('task-list');
    const taskDetailsContainer = document.getElementById('task-details');
    let currentWorkflows = [];
    let selectedWorkflowId = null;

    // --- Helper Functions ---
    function escapeHtml(text) {
        if (text === null || typeof text === 'undefined') return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function getStatusClass(status) {
        const statusMap = { 'running': 'running', 'completed': 'completed', 'failed': 'failed', 'pending': 'pending' };
        return statusMap[status.toLowerCase()] || '';
    }

    function isAttachedSubtask(subTaskName) {
        /**
         * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–¥–∑–∞–¥–∞—á–∞ –ø—Ä–∏–≤—è–∑–∞–Ω–Ω–æ–π –∫ —Ñ–∞–π–ª—É AI –Ω–∞—Ä–µ–∑–∫–∏.
         * –§–æ—Ä–º–∞—Ç –ø—Ä–∏–≤—è–∑–∞–Ω–Ω–æ–π –ø–æ–¥–∑–∞–¥–∞—á–∏: {type}_{system_prompt_id}_{user_prompt_id}_{timestamp}
         * –ü—Ä–∏–º–µ—Ä: clipping_3bdf04d7-ed20-4e04-8571-f4885fd7287e_b15891d5-7851-480f-b6ac-389a574b4e0a_20251106_171205
         */
        const parts = subTaskName.split('_');
        if (parts.length < 4) return false;
        
        const type = parts[0];
        const validTypes = ['clipping', 'compilation', 'shorts_creation'];
        if (!validTypes.includes(type)) return false;
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –µ—Å—Ç—å timestamp –≤ –∫–æ–Ω—Ü–µ (—Ñ–æ—Ä–º–∞—Ç YYYYMMDD_HHMMSS)
        const lastPart = parts[parts.length - 1];
        const secondLastPart = parts[parts.length - 2];
        const timestampPattern = /^\d{8}_\d{6}$/;
        if (timestampPattern.test(secondLastPart + '_' + lastPart)) {
            return true;
        }
        
        return false;
    }

    function getSubTaskTitle(subTaskName) {
        const titles = {
            'initial_processing': '1. –ù–∞—á–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞',
            'transcription': '2. –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è (Colab)',
            'ai_clip_generation': '3. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è AI-–Ω–∞—Ä–µ–∑–∫–∏',
            'clipping': '4. –ù–∞—Ä–µ–∑–∫–∞ –∫–ª–∏–ø–æ–≤',
            'compilation': '5. –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏',
            'shorts_creation': '6. –°–æ–∑–¥–∞–Ω–∏–µ Shorts'
        };
        return titles[subTaskName] || subTaskName;
    }

    // --- Rendering Functions ---

    function renderTaskList(workflows) {
        currentWorkflows = workflows;
        taskListContainer.innerHTML = '<h2>üöÄ –†–∞–±–æ—á–∏–µ –ø—Ä–æ—Ü–µ—Å—Å—ã</h2>';
        if (workflows.length === 0) {
            taskListContainer.innerHTML += '<div class="empty-state"><p>–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤.</p></div>';
            return;
        }

        workflows.forEach(workflow => {
            const taskItem = document.createElement('div');
            taskItem.className = `task-item ${workflow.task_id === selectedWorkflowId ? 'active' : ''}`;
            taskItem.dataset.taskId = workflow.task_id;
            
            taskItem.innerHTML = `
                <h4>${escapeHtml(workflow.name)}</h4>
                <div class="task-meta">
                    <span class="task-status ${getStatusClass(workflow.status)}">${escapeHtml(workflow.status)}</span>
                </div>
            `;
            taskItem.addEventListener('click', () => {
                selectedWorkflowId = workflow.task_id;
                renderTaskList(currentWorkflows);
                renderTaskDetails(workflow.task_id);
            });
            taskListContainer.appendChild(taskItem);
        });
    }

    function renderTaskDetails(workflowId) {
        fetch(`/api/tasks/${workflowId}`)
            .then(response => response.json())
            .then(data => {
                if (!data.success) {
                    taskDetailsContainer.innerHTML = `<div class="detail-block"><h3>–û—à–∏–±–∫–∞</h3><p>${escapeHtml(data.error)}</p></div>`;
                    return;
                }
                const workflow = data.task;
                
                // Main Workflow Block
                let detailsHtml = `
                    <div class="detail-block">
                        <h3>${escapeHtml(workflow.name)}</h3>
                        <p><strong>ID:</strong> <code>${escapeHtml(workflow.task_id)}</code></p>
                        <p><strong>–°—Ç–∞—Ç—É—Å:</strong> <span class="task-status ${getStatusClass(workflow.status)}">${escapeHtml(workflow.status)}</span></p>
                        ${workflow.error ? `<div class="status-message error"><strong>–û—à–∏–±–∫–∞:</strong> ${escapeHtml(workflow.error)}</div>` : ''}
                    </div>
                `;

                // Render Sub-Tasks (—Å–∫—Ä—ã–≤–∞–µ–º –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–µ –ø–æ–¥–∑–∞–¥–∞—á–∏ - –æ–Ω–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –≤ –∫–∞—Ä—Ç–æ—á–∫–∞—Ö)
                const sortedSubTasks = Object.entries(workflow.sub_tasks).sort((a, b) => getSubTaskTitle(a[0]).localeCompare(getSubTaskTitle(b[0])));

                for (const [subTaskName, subTask] of sortedSubTasks) {
                    // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–µ –ø–æ–¥–∑–∞–¥–∞—á–∏ - –æ–Ω–∏ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –≤ –∫–∞—Ä—Ç–æ—á–∫–∞—Ö
                    if (isAttachedSubtask(subTaskName)) {
                        continue;
                    }
                    detailsHtml += renderSubTask(workflow, subTaskName, subTask);
                }

                taskDetailsContainer.innerHTML = detailsHtml;
                attachEventListeners(workflow);
            });
    }

    function renderSubTask(workflow, subTaskName, subTask) {
        let filesHtml = '';
        
        // –î–ª—è ai_clip_generation –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫–∏ –≤–º–µ—Å—Ç–æ –ø—Ä–æ—Å—Ç—ã—Ö —Å—Å—ã–ª–æ–∫
        if (subTaskName === 'ai_clip_generation' && workflow.artifacts && workflow.artifacts.ai_clips_files) {
            const files = workflow.artifacts.ai_clips_files;
            if (files.length > 0) {
                // –ö–∞—Ä—Ç–æ—á–∫–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ actionsHtml, –∑–¥–µ—Å—å –Ω–µ –Ω—É–∂–Ω–æ
                filesHtml = ''; // –û—á–∏—â–∞–µ–º, —á—Ç–æ–±—ã –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –¥—É–±–ª–∏—Ä—É—é—â—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
            }
        } else if (subTask.outputs) {
            // –î–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –ø–æ–¥–∑–∞–¥–∞—á - —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –ª–æ–≥–∏–∫–∞
            for (const [key, value] of Object.entries(subTask.outputs)) {
                if (typeof value === 'string') {
                    // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –ø—É—Ç–∏ —Å / –∏–ª–∏ \
                    const separator = value.includes('/') ? '/' : '\\';
                    const fileName = value.split(separator).pop();
                    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø —Ñ–∞–π–ª–∞ –ø–æ –∫–ª—é—á—É –∏–ª–∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—é
                    let downloadUrl = '';
                    if (key === 'shorts' || fileName.endsWith('.mp4')) {
                        // –î–ª—è Shorts –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π endpoint
                        if (value.includes('shorts_output') || key === 'shorts') {
                            downloadUrl = `/api/files/short/${encodeURIComponent(fileName)}`;
                        } else if (value.includes('clips')) {
                            downloadUrl = `/api/files/clip/${encodeURIComponent(fileName)}`;
                        } else if (value.includes('downloads')) {
                            downloadUrl = `/api/files/video/${encodeURIComponent(fileName)}`;
                        } else {
                            downloadUrl = `/api/files/any/${encodeURIComponent(fileName)}`;
                        }
                    } else {
                        downloadUrl = `/api/files/any/${encodeURIComponent(fileName)}`;
                    }
                    filesHtml += `<a href="${downloadUrl}" target="_blank" class="file-link">üì• ${escapeHtml(key)}: ${escapeHtml(fileName)}</a>`;
                } else if (Array.isArray(value)) {
                    // –î–ª—è –º–∞—Å—Å–∏–≤–æ–≤ —Ñ–∞–π–ª–æ–≤ —Å–æ–∑–¥–∞–µ–º —Å—Å—ã–ª–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ñ–∞–π–ª–∞
                    if (value.length > 0 && typeof value[0] === 'string') {
                        filesHtml += `<p><strong>${escapeHtml(key)}:</strong> ${value.length} ${value.length === 1 ? '—Ñ–∞–π–ª' : '—Ñ–∞–π–ª–æ–≤'}</p>`;
                        filesHtml += '<div class="file-list">';
                        value.forEach(filePath => {
                            const separator = filePath.includes('/') ? '/' : '\\';
                            const fileName = filePath.split(separator).pop();
                            let downloadUrl = '';
                            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø —Ñ–∞–π–ª–∞ –ø–æ –ø—É—Ç–∏
                            if (filePath.includes('shorts_output') || key === 'shorts') {
                                downloadUrl = `/api/files/short/${encodeURIComponent(fileName)}`;
                            } else if (filePath.includes('clips') || key === 'clips') {
                                downloadUrl = `/api/files/clip/${encodeURIComponent(fileName)}`;
                            } else if (filePath.includes('downloads')) {
                                downloadUrl = `/api/files/video/${encodeURIComponent(fileName)}`;
                            } else {
                                downloadUrl = `/api/files/any/${encodeURIComponent(fileName)}`;
                            }
                            filesHtml += `<a href="${downloadUrl}" target="_blank" class="file-link">üì• ${escapeHtml(fileName)}</a>`;
                        });
                        filesHtml += '</div>';
                    } else if (value.length === 0) {
                        // –ü—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, failed_shorts)
                        filesHtml += `<p><strong>${escapeHtml(key)}:</strong> 0 —ç–ª–µ–º–µ–Ω—Ç–æ–≤</p>`;
                    } else {
                        filesHtml += `<p><strong>${escapeHtml(key)}:</strong> ${value.length} —ç–ª–µ–º–µ–Ω—Ç–æ–≤</p>`;
                    }
                }
            }
        }

        let actionsHtml = '';
        // --- Conditional Actions ---
        if (subTaskName === 'initial_processing' && subTask.status === 'completed' && !workflow.sub_tasks.transcription) {
            actionsHtml += `<p class="status-message info">–û–∂–∏–¥–∞–Ω–∏–µ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏ –æ—Ç Google Colab...</p>`;
        }
        // –ö–Ω–æ–ø–∫–∞ –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø–æ–ø—ã—Ç–∫–∏ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏ –ø—Ä–∏ –æ—à–∏–±–∫–µ –∏–ª–∏ –∑–∞–≤–∏—Å–∞–Ω–∏–∏
        if (subTaskName === 'transcription' && (subTask.status === 'failed' || subTask.status === 'running')) {
            actionsHtml += `
                <button class="btn btn-retry-transcription" data-task-id="${escapeHtml(workflow.task_id)}" style="margin-top: 10px;">
                    üîÑ –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –µ—â–µ —Ä–∞–∑
                </button>
            `;
        }
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –≤—Å–µ–≥–¥–∞ –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏
        if (subTaskName === 'transcription' && subTask.status === 'completed') {
            actionsHtml += `
                <div class="form-group">
                    <label for="ai-system-prompt">–°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç:</label>
                    <select id="ai-system-prompt" class="form-select"></select>
                </div>
                <div class="form-group">
                    <label for="ai-user-prompt">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –ø—Ä–æ–º–ø—Ç:</label>
                    <select id="ai-user-prompt" class="form-select"></select>
                </div>
                <button class="btn" id="btn-generate-ai-clips">‚ú® –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å AI –Ω–∞—Ä–µ–∑–∫—É</button>
            `;
            const aiClipGeneration = workflow.sub_tasks.ai_clip_generation;
            if (aiClipGeneration && aiClipGeneration.status === 'failed') {
                actionsHtml += `<p class="status-message error" style="margin-top: 10px;">–ü—Ä–µ–¥—ã–¥—É—â–∞—è –ø–æ–ø—ã—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å —Å –æ—à–∏–±–∫–æ–π. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø—Ä–æ–º–ø—Ç—ã.</p>`;
            }
        }
        // –î–ª—è ai_clip_generation –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫–∏ —Å —Ñ–∞–π–ª–∞–º–∏ –ø–æ—Å–ª–µ —Å—Ç–∞—Ç—É—Å–∞
        if (subTaskName === 'ai_clip_generation' && workflow.artifacts && workflow.artifacts.ai_clips_files && workflow.artifacts.ai_clips_files.length > 0) {
            const files = workflow.artifacts.ai_clips_files;
            actionsHtml += '<div class="ai-clips-section">';
            actionsHtml += `<h5 style="margin-top: 20px; margin-bottom: 15px;">–°–æ–∑–¥–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã AI –Ω–∞—Ä–µ–∑–∫–∏ (${files.length}):</h5>`;
            actionsHtml += '<div class="ai-clips-cards">';
            
            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–º–µ–Ω–∏ –ø–æ–¥–∑–∞–¥–∞—á–∏ (–∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ Python —Ñ—É–Ω–∫—Ü–∏–∏)
            function generateSubtaskName(fileInfo, subtaskType) {
                const systemPromptId = fileInfo.system_prompt_id || 'unknown';
                const userPromptId = fileInfo.user_prompt_id || 'unknown';
                const createdAt = fileInfo.created_at || Date.now() / 1000;
                const date = new Date(createdAt * 1000);
                const timestampStr = date.getFullYear().toString() + 
                    String(date.getMonth() + 1).padStart(2, '0') + 
                    String(date.getDate()).padStart(2, '0') + '_' +
                    String(date.getHours()).padStart(2, '0') + 
                    String(date.getMinutes()).padStart(2, '0') + 
                    String(date.getSeconds()).padStart(2, '0');
                return `${subtaskType}_${systemPromptId}_${userPromptId}_${timestampStr}`;
            }
            
            files.forEach((fileInfo, index) => {
                const fileName = escapeHtml(fileInfo.filename);
                const systemPrompt = escapeHtml(fileInfo.system_prompt_name || fileInfo.system_prompt_id);
                const userPrompt = escapeHtml(fileInfo.user_prompt_name || fileInfo.user_prompt_id);
                const createdDate = fileInfo.created_at ? new Date(fileInfo.created_at * 1000).toLocaleString('ru-RU') : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
                const subTasks = fileInfo.sub_tasks || {};
                
                // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º ID –¥–ª—è —Ä–∞—Å–∫—Ä—ã–≤–∞—é—â–µ–≥–æ—Å—è –±–ª–æ–∫–∞ (–∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É –¥–ª—è —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏)
                const cardId = `card-${workflow.task_id}-${index}-${fileInfo.path.replace(/[^a-zA-Z0-9]/g, '_').substring(0, 50)}`;
                
                // –§–æ—Ä–º–∏—Ä—É–µ–º HTML –¥–ª—è –ø–æ–¥–∑–∞–¥–∞—á
                let subtasksHtml = '';
                const subtaskTypes = {
                    'clipping': { name: '–ù–∞—Ä–µ–∑–∫–∞ –∫–ª–∏–ø–æ–≤', icon: '‚úÇÔ∏è' },
                    'compilation': { name: '–ö–æ–º–ø–∏–ª—è—Ü–∏—è', icon: 'üé¨' },
                    'shorts_creation': { name: 'Shorts', icon: 'üì±' }
                };
                
                for (const [type, info] of Object.entries(subtaskTypes)) {
                    const subtask = subTasks[type];
                    if (subtask) {
                        const status = subtask.status || 'pending';
                        const statusClass = getStatusClass(status);
                        const message = escapeHtml(subtask.message || '');
                        const progress = subtask.progress || 0;
                        const error = subtask.error ? escapeHtml(subtask.error) : '';
                        const outputs = subtask.outputs || {};
                        
                        subtasksHtml += `
                            <div class="subtask-item">
                                <div class="subtask-header">
                                    <span class="subtask-icon">${info.icon}</span>
                                    <span class="subtask-name">${info.name}</span>
                                    <span class="task-status ${statusClass}">${escapeHtml(status)}</span>
                                </div>
                                ${message ? `<p class="subtask-message">${message}</p>` : ''}
                                ${progress > 0 ? `<div class="progress-bar-small"><div class="progress-bar-fill" style="width: ${progress}%;"></div></div>` : ''}
                                ${error ? `<p class="subtask-error">${error}</p>` : ''}
                                ${Object.keys(outputs).length > 0 ? `
                                    <div class="subtask-outputs">
                                        ${Object.entries(outputs).map(([key, value]) => {
                                            if (Array.isArray(value)) {
                                                return `<p><strong>${escapeHtml(key)}:</strong> ${value.length} —ç–ª–µ–º–µ–Ω—Ç–æ–≤</p>`;
                                            } else if (typeof value === 'string' && value.includes('\\')) {
                                                const fileName = value.split('\\').pop();
                                                return `<a href="/api/files/any/${encodeURIComponent(fileName)}" target="_blank">${escapeHtml(key)}: ${escapeHtml(fileName)}</a>`;
                                            }
                                            return '';
                                        }).join('')}
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    }
                }
                
                actionsHtml += `
                    <div class="ai-clip-card" data-file-path="${escapeHtml(fileInfo.path)}">
                        <div class="ai-clip-card-header">
                            <h5>${fileName}</h5>
                            <span class="ai-clip-card-date">${createdDate}</span>
                        </div>
                        <div class="ai-clip-card-info">
                            <p><strong>–°–∏—Å—Ç–µ–º–Ω—ã–π:</strong> ${systemPrompt}</p>
                            <p><strong>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π:</strong> ${userPrompt}</p>
                        </div>
                        <div class="ai-clip-card-actions">
                            <a href="/api/files/any/${encodeURIComponent(fileInfo.filename)}" target="_blank" class="btn btn-small">üì• –°–∫–∞—á–∞—Ç—å</a>
                            <button class="btn btn-small btn-create-compilation" data-file-path="${escapeHtml(fileInfo.path)}">üé¨ –ö–æ–º–ø–∏–ª—è—Ü–∏—è</button>
                            <button class="btn btn-small btn-create-clips" data-file-path="${escapeHtml(fileInfo.path)}">‚úÇÔ∏è –ö–ª–∏–ø—ã</button>
                            ${subTasks.clipping && subTasks.clipping.status === 'completed' && subTasks.clipping.outputs && subTasks.clipping.outputs.clips ? 
                                `<button class="btn btn-small btn-toggle-shorts-form" data-card-id="${cardId}" data-file-path="${escapeHtml(fileInfo.path)}" data-clipping-subtask="${escapeHtml(generateSubtaskName(fileInfo, 'clipping'))}" onclick="toggleShortsForm('${cardId}')">
                                    <span class="toggle-icon">‚ñº</span> üì± Shorts
                                </button>` : ''}
                        </div>
                        ${subTasks.clipping && subTasks.clipping.status === 'completed' && subTasks.clipping.outputs && subTasks.clipping.outputs.clips ? 
                            `<div class="shorts-settings-form" id="shorts-form-${cardId}" style="display: none;" data-file-path="${escapeHtml(fileInfo.path)}" data-clipping-subtask="${escapeHtml(generateSubtaskName(fileInfo, 'clipping'))}">
                                <div class="shorts-form-content">
                                    <h6 style="margin-top: 0; margin-bottom: 15px;">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ Shorts</h6>
                                    <div class="form-group">
                                        <label>–ë–∞–Ω–Ω–µ—Ä:</label>
                                        <select class="form-select shorts-setting" data-setting="banner_path" id="banner-${cardId}">
                                            <option value="">–ë–µ–∑ –±–∞–Ω–Ω–µ—Ä–∞</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>–¢–µ–∫—Å—Ç –≤–æ–¥—è–Ω–æ–≥–æ –∑–Ω–∞–∫–∞:</label>
                                        <input type="text" class="form-input shorts-setting" data-setting="watermark_text" id="watermark-text-${cardId}" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: @channel">
                                    </div>
                                    <div class="form-group">
                                        <label>–¶–≤–µ—Ç –≤–æ–¥—è–Ω–æ–≥–æ –∑–Ω–∞–∫–∞:</label>
                                        <select class="form-select shorts-setting" data-setting="watermark_color" id="watermark-color-${cardId}">
                                            <option value="gray">–°–µ—Ä—ã–π</option>
                                            <option value="white">–ë–µ–ª—ã–π</option>
                                            <option value="black">–ß–µ—Ä–Ω—ã–π</option>
                                            <option value="red">–ö—Ä–∞—Å–Ω—ã–π</option>
                                            <option value="blue">–°–∏–Ω–∏–π</option>
                                            <option value="green">–ó–µ–ª–µ–Ω—ã–π</option>
                                            <option value="yellow">–ñ–µ–ª—Ç—ã–π</option>
                                            <option value="orange">–û—Ä–∞–Ω–∂–µ–≤—ã–π</option>
                                            <option value="purple">–§–∏–æ–ª–µ—Ç–æ–≤—ã–π</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>–†–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞ –≤–æ–¥—è–Ω–æ–≥–æ –∑–Ω–∞–∫–∞:</label>
                                        <input type="number" class="form-input shorts-setting" data-setting="watermark_font_size" id="watermark-font-size-${cardId}" value="72" min="10" max="200">
                                    </div>
                                    <div class="form-group">
                                        <label>–û—Ç—Å—Ç—É–ø —Å–Ω–∏–∑—É –¥–ª—è –≤–æ–¥—è–Ω–æ–≥–æ –∑–Ω–∞–∫–∞ (px):</label>
                                        <input type="number" class="form-input shorts-setting" data-setting="watermark_bottom_offset" id="watermark-bottom-offset-${cardId}" value="180" min="0" max="500">
                                    </div>
                                    <div class="form-group">
                                        <label>–û—Ç—Å—Ç—É–ø —Å–≤–µ—Ä—Ö—É –¥–ª—è –±–∞–Ω–Ω–µ—Ä–∞ (px):</label>
                                        <input type="number" class="form-input shorts-setting" data-setting="banner_offset" id="banner-offset-${cardId}" value="100" min="0" max="500">
                                    </div>
                                    <div class="form-group">
                                        <label>–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç —É–≤–µ–ª–∏—á–µ–Ω–∏—è –≤—ã—Å–æ—Ç—ã:</label>
                                        <input type="number" class="form-input shorts-setting" data-setting="height_scale" id="height-scale-${cardId}" value="2.0" min="0.5" max="5.0" step="0.1">
                                    </div>
                                    <div class="form-group">
                                        <label>
                                            <input type="checkbox" class="shorts-use-global" id="use-global-${cardId}" checked> –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
                                        </label>
                                    </div>
                                    <div class="shorts-form-actions">
                                        <button class="btn btn-small btn-save-shorts-settings" data-card-id="${cardId}">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
                                        <button class="btn btn-small btn-create-shorts-from-card" data-file-path="${escapeHtml(fileInfo.path)}" data-clipping-subtask="${escapeHtml(generateSubtaskName(fileInfo, 'clipping'))}" data-card-id="${cardId}">üöÄ –°–æ–∑–¥–∞—Ç—å Shorts</button>
                                    </div>
                                </div>
                            </div>` : ''}
                        ${Object.keys(subTasks).length > 0 ? `
                            <div class="ai-clip-card-subtasks">
                                <button class="btn-toggle-subtasks" data-card-id="${cardId}" onclick="toggleSubtasks('${cardId}')">
                                    <span class="toggle-icon">‚ñº</span> –ü–æ–¥–∑–∞–¥–∞—á–∏ (${Object.keys(subTasks).length})
                                </button>
                                <div class="subtasks-content" id="${cardId}" style="display: none;">
                                    ${subtasksHtml || '<p class="subtask-empty">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–¥–∑–∞–¥–∞—á</p>'}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
            });
            actionsHtml += '</div></div>';
        }
        
        if (subTaskName === 'clipping' && subTask.status === 'completed') {
             actionsHtml += `<button class="btn" id="btn-create-shorts">üì± –°–æ–∑–¥–∞—Ç—å Shorts</button>`;
        }


        return `
            <div class="sub-task-block" id="sub-task-${subTaskName}">
                <h4>${getSubTaskTitle(subTaskName)}</h4>
                <p><strong>–°—Ç–∞—Ç—É—Å:</strong> <span class="task-status ${getStatusClass(subTask.status)}">${escapeHtml(subTask.status)}</span></p>
                <p>${escapeHtml(subTask.message)}</p>
                <div class="progress-bar"><div class="progress-bar-fill" style="width: ${subTask.progress}%;"></div></div>
                ${subTask.error ? `<div class="status-message error"><strong>–û—à–∏–±–∫–∞:</strong> ${escapeHtml(subTask.error)}</div>` : ''}
                
                ${filesHtml ? `<h5>–í—ã—Ö–æ–¥–Ω—ã–µ —Ñ–∞–π–ª—ã:</h5><div class="file-list">${filesHtml}</div>` : ''}
                ${actionsHtml ? `<div class="actions" style="margin-top: 20px;">${actionsHtml}</div>` : ''}
                <div id="status-${subTaskName}" class="status-message" style="display:none;"></div>
            </div>
        `;
    }


    window.toggleShortsForm = function(cardId) {
        const form = document.getElementById(`shorts-form-${cardId}`);
        if (!form) return;
        
        const button = document.querySelector(`.btn-toggle-shorts-form[data-card-id="${cardId}"]`);
        if (!button) return;
        
        const icon = button.querySelector('.toggle-icon');
        if (!icon) return;
        
        if (form.style.display === 'none' || !form.style.display) {
            form.style.display = 'block';
            icon.textContent = '‚ñ≤';
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –±–∞–Ω–Ω–µ—Ä—ã –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –æ—Ç–∫—Ä—ã—Ç–∏–∏
            if (!form.dataset.loaded) {
                loadShortsFormData(cardId);
                form.dataset.loaded = 'true';
            }
        } else {
            form.style.display = 'none';
            icon.textContent = '‚ñº';
        }
    };
    
    function loadShortsFormData(cardId) {
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –±–∞–Ω–Ω–µ—Ä–æ–≤
        fetch('/api/files/list/banners')
            .then(res => res.json())
            .then(data => {
                if (data.success && data.banners) {
                    const select = document.getElementById(`banner-${cardId}`);
                    if (select) {
                        // –û—á–∏—â–∞–µ–º –æ–ø—Ü–∏–∏ –∫—Ä–æ–º–µ –ø–µ—Ä–≤–æ–π
                        while (select.options.length > 1) {
                            select.remove(1);
                        }
                        // –î–æ–±–∞–≤–ª—è–µ–º –±–∞–Ω–Ω–µ—Ä—ã
                        data.banners.forEach(banner => {
                            const option = document.createElement('option');
                            option.value = banner.path;
                            option.textContent = banner.name;
                            select.appendChild(option);
                        });
                    }
                }
            })
            .catch(err => console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–∞–Ω–Ω–µ—Ä–æ–≤:', err));
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
        fetch('/api/shorts/settings')
            .then(res => res.json())
            .then(data => {
                if (data.success && data.settings) {
                    const useGlobal = document.getElementById(`use-global-${cardId}`);
                    if (useGlobal && useGlobal.checked) {
                        applySettingsToForm(cardId, data.settings);
                    }
                }
            })
            .catch(err => console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫:', err));
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ñ–∞–π–ª–∞
        const form = document.getElementById(`shorts-form-${cardId}`);
        if (form) {
            const filePath = form.dataset.filePath;
            // –ù–∞—Ö–æ–¥–∏–º file_info –≤ workflow
            if (currentWorkflows && currentWorkflows.length > 0) {
                const workflow = currentWorkflows.find(w => {
                    return w.artifacts && w.artifacts.ai_clips_files && 
                           w.artifacts.ai_clips_files.some(fi => fi.path === filePath);
                });
                if (workflow) {
                    const fileInfo = workflow.artifacts.ai_clips_files.find(fi => fi.path === filePath);
                    if (fileInfo && fileInfo.sub_tasks && fileInfo.sub_tasks.shorts_creation && fileInfo.sub_tasks.shorts_creation.params) {
                        applySettingsToForm(cardId, fileInfo.sub_tasks.shorts_creation.params);
                    }
                }
            }
        }
    }
    
    function applySettingsToForm(cardId, settings) {
        Object.keys(settings).forEach(key => {
            const element = document.querySelector(`#shorts-form-${cardId} .shorts-setting[data-setting="${key}"]`);
            if (element) {
                if (element.type === 'checkbox') {
                    element.checked = settings[key];
                } else {
                    element.value = settings[key] || '';
                }
            }
        });
    }
    
    function getShortsFormData(cardId) {
        const form = document.getElementById(`shorts-form-${cardId}`);
        if (!form) return {};
        
        const settings = {};
        form.querySelectorAll('.shorts-setting').forEach(input => {
            const key = input.dataset.setting;
            if (input.type === 'checkbox') {
                settings[key] = input.checked;
            } else if (input.type === 'number') {
                settings[key] = input.value ? parseFloat(input.value) : null;
            } else {
                settings[key] = input.value || null;
            }
        });
        
        return settings;
    }
    
    window.toggleSubtasks = function(cardId) {
        const content = document.getElementById(cardId);
        if (!content) return;
        
        const button = document.querySelector(`[data-card-id="${cardId}"]`);
        if (!button) return;
        
        const icon = button.querySelector('.toggle-icon');
        if (!icon) return;
        
        if (content.style.display === 'none' || !content.style.display) {
            content.style.display = 'block';
            icon.textContent = '‚ñ≤';
        } else {
            content.style.display = 'none';
            icon.textContent = '‚ñº';
        }
    };

    function attachEventListeners(workflow) {
        // –ö–Ω–æ–ø–∫–∞ –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø–æ–ø—ã—Ç–∫–∏ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏
        document.querySelectorAll('.btn-retry-transcription').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const taskId = e.target.dataset.taskId;
                if (!taskId) return;
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
                const statusEl = document.getElementById('status-transcription');
                if (statusEl) {
                    statusEl.className = 'status-message info';
                    statusEl.textContent = '–°–±—Ä–æ—Å –ø–æ–¥–∑–∞–¥–∞—á–∏ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏...';
                    statusEl.style.display = 'block';
                }
                
                // –û—Ç–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫—É –Ω–∞ –≤—Ä–µ–º—è –∑–∞–ø—Ä–æ—Å–∞
                btn.disabled = true;
                btn.textContent = '‚è≥ –û–±—Ä–∞–±–æ—Ç–∫–∞...';
                
                // –í—ã–∑—ã–≤–∞–µ–º API –¥–ª—è —Å–±—Ä–æ—Å–∞
                fetch(`/api/colab/reset-transcription/${taskId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                })
                .then(response => response.json())
                .then(data => {
                    if (statusEl) {
                        if (data.success) {
                            statusEl.className = 'status-message success';
                            statusEl.textContent = data.message || '–ü–æ–¥–∑–∞–¥–∞—á–∞ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏ —É—Å–ø–µ—à–Ω–æ —Å–±—Ä–æ—à–µ–Ω–∞! –ó–∞–¥–∞—á–∞ —Ç–µ–ø–µ—Ä—å –¥–æ—Å—Ç—É–ø–Ω–∞ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤ Colab.';
                        } else {
                            statusEl.className = 'status-message error';
                            statusEl.textContent = `–û—à–∏–±–∫–∞: ${data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`;
                        }
                    }
                    // –û–±–Ω–æ–≤–ª—è–µ–º –¥–µ—Ç–∞–ª–∏ –∑–∞–¥–∞—á–∏ –ø–æ—Å–ª–µ –∫–æ—Ä–æ—Ç–∫–æ–π –∑–∞–¥–µ—Ä–∂–∫–∏
                    setTimeout(() => {
                        renderTaskDetails(selectedWorkflowId);
                    }, 1000);
                })
                .catch(err => {
                    if (statusEl) {
                        statusEl.className = 'status-message error';
                        statusEl.textContent = `–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞: ${err}`;
                    }
                    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –ø—Ä–∏ –æ—à–∏–±–∫–µ
                    btn.disabled = false;
                    btn.textContent = 'üîÑ –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –µ—â–µ —Ä–∞–∑';
                });
            });
        });
        
        // AI Clip Generation
        const btnGenAiClips = document.getElementById('btn-generate-ai-clips');
        if (btnGenAiClips) {
            const systemPromptSelect = document.getElementById('ai-system-prompt');
            const userPromptSelect = document.getElementById('ai-user-prompt');
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –ø–µ—Ä–µ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º
            const savedSystemPrompt = localStorage.getItem(`ai-system-prompt-${workflow.task_id}`);
            const savedUserPrompt = localStorage.getItem(`ai-user-prompt-${workflow.task_id}`);
            
            // Load prompts
            Promise.all([
                fetch('/api/prompts/system').then(res => res.json()),
                fetch('/api/prompts/user').then(res => res.json())
            ]).then(([systemData, userData]) => {
                if(systemData.success) systemData.prompts.forEach(p => systemPromptSelect.add(new Option(p.name, p.id)));
                if(userData.success) userData.prompts.forEach(p => userPromptSelect.add(new Option(p.name, p.id)));
                
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
                if (savedSystemPrompt) {
                    systemPromptSelect.value = savedSystemPrompt;
                }
                if (savedUserPrompt) {
                    userPromptSelect.value = savedUserPrompt;
                }
            });

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏
            systemPromptSelect.addEventListener('change', () => {
                localStorage.setItem(`ai-system-prompt-${workflow.task_id}`, systemPromptSelect.value);
            });
            userPromptSelect.addEventListener('change', () => {
                localStorage.setItem(`ai-user-prompt-${workflow.task_id}`, userPromptSelect.value);
            });

            btnGenAiClips.addEventListener('click', () => {
                const body = {
                    system_prompt_id: systemPromptSelect.value,
                    user_prompt_id: userPromptSelect.value
                };
                // –û—á–∏—â–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏
                localStorage.removeItem(`ai-system-prompt-${workflow.task_id}`);
                localStorage.removeItem(`ai-user-prompt-${workflow.task_id}`);
                handleApiCall(`/api/tasks/${workflow.task_id}/generate-ai-clips`, body, 'ai_clip_generation');
            });
        }

        // Compilation from AI clips (cards)
        document.querySelectorAll('.btn-create-compilation').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const filePath = e.target.dataset.filePath;
                const body = { 
                    task_id: workflow.task_id, 
                    moments_source: 'ai_clip_generation',
                    ai_clips_file: filePath
                };
                handleApiCall('/api/compilation/start', body, 'compilation');
            });
        });
        
        // Clips creation from AI clips (cards)
        document.querySelectorAll('.btn-create-clips').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const filePath = e.target.dataset.filePath;
                const body = { 
                    task_id: workflow.task_id,
                    ai_clips_file: filePath
                };
                handleApiCall(`/api/tasks/${workflow.task_id}/create-clips-from-ai`, body, 'clipping');
            });
        });
        
        // Shorts creation from manual clips (—Å—Ç–∞—Ä–∞—è –∫–Ω–æ–ø–∫–∞ –≤ –±–ª–æ–∫–µ clipping)
        const btnCreateShorts = document.getElementById('btn-create-shorts');
        if(btnCreateShorts) {
            btnCreateShorts.addEventListener('click', () => {
                // Here you can add a form to get shorts creation parameters
                const body = { task_id: workflow.task_id, clips_source: 'clipping' };
                handleApiCall('/api/shorts/start', body, 'shorts_creation');
            });
        }
        
        // Shorts creation from cards
        document.querySelectorAll('.btn-create-shorts-from-card').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const cardId = e.target.dataset.cardId;
                const filePath = e.target.dataset.filePath;
                const clippingSubtask = e.target.dataset.clippingSubtask;
                
                // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ñ–æ—Ä–º—ã
                const formData = getShortsFormData(cardId);
                
                // –û–±—ä–µ–¥–∏–Ω—è–µ–º —Å –±–∞–∑–æ–≤—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
                const body = { 
                    task_id: workflow.task_id, 
                    clips_source: clippingSubtask,
                    ai_clips_file: filePath,
                    ...formData
                };
                handleApiCall('/api/shorts/start', body, 'shorts_creation');
            });
        });
        
        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ Shorts –¥–ª—è —Ñ–∞–π–ª–∞
        document.querySelectorAll('.btn-save-shorts-settings').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const cardId = e.target.dataset.cardId;
                const form = document.getElementById(`shorts-form-${cardId}`);
                if (!form) return;
                
                const filePath = form.dataset.filePath;
                const formData = getShortsFormData(cardId);
                
                // –ù–∞—Ö–æ–¥–∏–º workflow –∏ file_info
                if (currentWorkflows && currentWorkflows.length > 0) {
                    const workflow = currentWorkflows.find(w => {
                        return w.artifacts && w.artifacts.ai_clips_files && 
                               w.artifacts.ai_clips_files.some(fi => fi.path === filePath);
                    });
                    if (workflow) {
                        const fileIndex = workflow.artifacts.ai_clips_files.findIndex(fi => fi.path === filePath);
                        if (fileIndex !== -1) {
                            const fileInfo = workflow.artifacts.ai_clips_files[fileIndex];
                            if (!fileInfo.sub_tasks) {
                                fileInfo.sub_tasks = {};
                            }
                            if (!fileInfo.sub_tasks.shorts_creation) {
                                fileInfo.sub_tasks.shorts_creation = {};
                            }
                            fileInfo.sub_tasks.shorts_creation.params = formData;
                            
                            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —á–µ—Ä–µ–∑ API
                            fetch(`/api/workflow/${workflow.task_id}/update-artifacts`, {
                                method: 'POST',
                                headers: {'Content-Type': 'application/json'},
                                body: JSON.stringify({
                                    ai_clips_files: workflow.artifacts.ai_clips_files
                                })
                            })
                            .then(res => res.json())
                            .then(data => {
                                if (data.success) {
                                    alert('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –¥–ª—è —ç—Ç–æ–≥–æ —Ñ–∞–π–ª–∞');
                                } else {
                                    alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                                }
                            })
                            .catch(err => {
                                console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫:', err);
                                alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫');
                            });
                        }
                    }
                }
            });
        });
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —á–µ–∫–±–æ–∫—Å–∞ "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏"
        document.querySelectorAll('.shorts-use-global').forEach(checkbox => {
            checkbox.addEventListener('change', (e) => {
                const cardId = checkbox.id.replace('use-global-', '');
                if (e.target.checked) {
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
                    fetch('/api/shorts/settings')
                        .then(res => res.json())
                        .then(data => {
                            if (data.success && data.settings) {
                                applySettingsToForm(cardId, data.settings);
                            }
                        })
                        .catch(err => console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫:', err));
                }
            });
        });
    }

    function handleApiCall(url, body, subTaskName) {
        const statusEl = document.getElementById(`status-${subTaskName}`);
        if (statusEl) {
            statusEl.className = 'status-message info';
            statusEl.textContent = '–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è...';
            statusEl.style.display = 'block';
        }

        fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body),
        })
        .then(response => response.json())
        .then(data => {
            if (statusEl) {
                if (data.success) {
                    statusEl.className = 'status-message success';
                    statusEl.textContent = data.message || '–ó–∞–¥–∞—á–∞ —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω–∞!';
                } else {
                    statusEl.className = 'status-message error';
                    statusEl.textContent = `–û—à–∏–±–∫–∞: ${data.error}`;
                }
            }
            // Refresh details after a short delay to allow backend to update
            setTimeout(() => renderTaskDetails(selectedWorkflowId), 1000);
        })
        .catch(err => {
            if (statusEl) {
                statusEl.className = 'status-message error';
                statusEl.textContent = `–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞: ${err}`;
            }
        });
    }

    // --- Initial Load and Polling ---
    let isUserInteracting = false; // –§–ª–∞–≥ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    
    function fetchWorkflows() {
        fetch('/api/tasks')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    renderTaskList(data.tasks);
                    if (selectedWorkflowId) {
                        // –û–±–Ω–æ–≤–ª—è–µ–º –¥–µ—Ç–∞–ª–∏ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤—É–µ—Ç —Å —Ñ–æ—Ä–º–æ–π
                        if (!isUserInteracting) {
                            const updatedWorkflow = data.tasks.find(t => t.task_id === selectedWorkflowId);
                            if (updatedWorkflow) {
                                renderTaskDetails(selectedWorkflowId);
                            }
                        }
                    }
                } else {
                    taskListContainer.innerHTML = '<h2>üöÄ –†–∞–±–æ—á–∏–µ –ø—Ä–æ—Ü–µ—Å—Å—ã</h2><div class="empty-state"><p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏.</p></div>';
                }
            });
    }

    // –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å —Ñ–æ—Ä–º–∞–º–∏
    document.addEventListener('focusin', (e) => {
        if (e.target.matches('select, input, textarea')) {
            isUserInteracting = true;
        }
    });
    
    document.addEventListener('focusout', (e) => {
        // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–¥ —Å–Ω—è—Ç–∏–µ–º —Ñ–ª–∞–≥–∞, —á—Ç–æ–±—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–≥ –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è –º–µ–∂–¥—É –ø–æ–ª—è–º–∏
        setTimeout(() => {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –Ω–∏ –æ–¥–Ω–æ –ø–æ–ª–µ –Ω–µ –≤ —Ñ–æ–∫—É—Å–µ
            const activeElement = document.activeElement;
            if (!activeElement || !activeElement.matches('select, input, textarea')) {
                isUserInteracting = false;
            }
        }, 200);
    });
    
    // –¢–∞–∫–∂–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –∫–ª–∏–∫–∏ –Ω–∞ –∫–Ω–æ–ø–∫–∏, —á—Ç–æ–±—ã –Ω–µ –æ–±–Ω–æ–≤–ª—è—Ç—å –≤–æ –≤—Ä–µ–º—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è
    document.addEventListener('mousedown', (e) => {
        if (e.target.matches('button, select, input, textarea')) {
            isUserInteracting = true;
        }
    });

    fetchWorkflows();
    setInterval(fetchWorkflows, 3000); // Poll every 3 seconds
});
</script>
{% endblock %}